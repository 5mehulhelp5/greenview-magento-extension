<?php
/**
 * Validate Button Template
 *
 * @var $block \GreenView\Viewer\Block\Adminhtml\System\Config\ValidateButton
 */
?>
<div id="greenview_validate_container">
    <?= $block->getButtonHtml() ?>
    <div id="greenview_validate_result" style="margin-top: 10px;"></div>
</div>

<script type="text/javascript">
require(['jquery', 'Magento_Ui/js/modal/alert'], function($, alert) {
    $('#greenview_validate_token').click(function() {
        var token = $('#greenview_viewer_general_company_token').val();

        if (!token) {
            alert({
                title: '<?= __('Error') ?>',
                content: '<?= __('Please enter a company token first') ?>'
            });
            return;
        }

        $('#greenview_validate_result').html('<span style="color: #666;"><?= __('Validating...') ?></span>');

        $.ajax({
            url: '<?= $block->getAjaxUrl() ?>',
            type: 'POST',
            dataType: 'json',
            data: {
                form_key: FORM_KEY,
                token: token
            },
            success: function(response) {
                if (response.success) {
                    $('#greenview_validate_result').html(
                        '<span style="color: #006400; font-weight: bold;">✓ ' + response.message + '</span>'
                    );
                } else {
                    var debugHtml = '';
                    if (response.debug) {
                        debugHtml = '<details style="margin-top: 10px; font-size: 12px;">' +
                            '<summary style="cursor: pointer; color: #666;">Show Debug Info</summary>' +
                            '<pre style="background: #f5f5f5; padding: 10px; margin-top: 5px; overflow: auto;">' +
                            JSON.stringify(response.debug, null, 2) +
                            '</pre></details>';
                    }
                    $('#greenview_validate_result').html(
                        '<span style="color: #8B0000; font-weight: bold;">✗ ' + response.message + '</span>' +
                        debugHtml
                    );
                }
            },
            error: function() {
                $('#greenview_validate_result').html(
                    '<span style="color: #8B0000; font-weight: bold;">✗ <?= __('Error validating token') ?></span>'
                );
            }
        });
    });
});
</script>
